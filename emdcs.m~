% chin jan 23 2013

% EMDCS: function for CS recon using EMD model

function [Xhat,xcosamp] = emdcs(yy,Phi,opt)

tol = opt.tol;
Its = opt.iter;
K = opt.K;
B = opt.B;
k = opt.k;
yy = yy(:); % 
[~,N] = size(Phi);

xcosamp = zeros(N,Its);
kk=1; 
maxiter= 1000;
s_cosamp = zeros(N,1);

while le(kk,Its),
    
    %----- EMD Model approximation---%
    rcosamp = yy - Phi*(s_cosamp);
    proxy_cosamp = Phi'*(rcosamp);
    
    tmp = reshape(proxy_cosamp,[],w);
    mags = tmp.^2;
    supp = emd_flow(mags,2*k,2*B,opt.verbose);
    supp = double(supp(:));
    tt_cosamp= union(find(ne(s_cosamp,0)),ne(supp,0));
    
    %------Least Squares------%
    w_cosamp = cgsolve(Phi(:,tt_cosamp)'*Phi(:,tt_cosamp), Phi(:,tt_cosamp)'*yy,...
                                        tol,maxiter, 0);
  
    bb2= zeros(N,1);
    bb2(tt_cosamp)= w_cosamp;
    
    %---Pruning----%
    kk = kk+1;   
    tmp = reshape(bb2,[],w);
    mags = tmp.^2;
    supp = emd_flow(mags,k,B,opt.verbose);
    s_cosamp(ww2(1:K))= bb2.*double(supp);


    xcosamp(:,kk) = s_cosamp; % current signal estimate
    if (norm(xcosamp(:,kk)-xcosamp(:,kk-1)) < 1e-3*norm(xcosamp(:,kk)))
       break;
    end
    
end
xcosamp(:,kk+1:end)=[];
Xhat = xcosamp(:,end);